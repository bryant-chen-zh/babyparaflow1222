# Chat 系统产品需求文档

## 1. 产品概述

### 1.1 产品定位

Chat 是 Visual Coding Agent 的核心交互入口。用户通过自然语言对话与 AI 协作，驱动产品规划工作的自动化执行。

### 1.2 核心价值

| 价值点 | 描述 |
|--------|------|
| **对话驱动** | 用户用自然语言描述需求，无需学习复杂操作 |
| **过程透明** | 实时展示 AI 思考过程、工具调用、任务进度 |
| **上下文关联** | 通过 @ Mention 关联画布上的节点，精准沟通 |
| **渐进式交互** | 通过问答收集关键决策，确保产出符合预期 |

---

## 2. 用户场景

### 2.1 典型使用流程：从零开始创建产品规划

以「帮我做一个外卖 App」为例，展示用户从发起需求到完成规划的完整流程。

---

**阶段一：需求输入**

用户在输入框描述产品想法，如「帮我做一个外卖 App，支持用户下单、骑手配送、商家管理」。发送后，消息以气泡形式显示在对话区右侧。

---

**阶段二：需求澄清**

AI 识别到这是一个新项目，需要进一步了解用户意图。此时出现**问题卡片**，包含 3-5 个关键决策问题：

- 项目类型（SaaS / 电商 / 社交 / 其他）
- 目标用户群体
- 技术复杂度偏好
- 是否需要后端规划

用户逐题选择答案，每选一题卡片自动滚动到下一题。用户可随时点击「跳过」跳过当前问题，或点击「继续」结束问答。

问答结束后，卡片自动折叠为答案摘要。

---

**阶段三：计划确认**

AI 根据需求和用户回答，生成**执行计划**。计划以任务列表形式展示，例如：

1. 创建产品需求文档
2. 设计用户流程图
3. 创建交互原型（5 个核心页面）
4. 编写后端架构规划
5. 设计数据库表结构
6. 配置第三方集成

计划底部显示「开始执行」按钮。用户点击后，按钮消失，AI 开始自动执行任务。

---

**阶段四：任务执行**

点击「开始执行」后，输入框上方出现**悬浮进度条**，显示当前任务和完成比例（如 1/6）。

AI 依次执行每个任务。执行过程中，Chat 面板会显示不同类型的消息：

- **思考消息**：AI 开始处理复杂任务时，显示「Thinking...」动画，让用户知道系统正在工作
- **工具调用消息**：AI 读取参考资料、搜索模板时，以简化文本显示（如「Read product-template.md」）
- **文件操作消息**：AI 在画布上创建节点时，显示卡片（如「📄 Product Requirements Doc - Created」），附带定位按钮

每完成一个任务，进度条自动更新，当前任务标记为完成，开始执行下一个任务。

---

**阶段五：结果查看**

全部任务完成后，进度条显示「Execution complete」。

用户可以：
- 点击文件操作消息中的**定位按钮**，画布自动平移并聚焦到对应节点
- 继续在输入框中与 AI 对话，提出修改意见或新需求

---

### 2.2 消息类型场景速查

| 消息类型 | 使用场景 | 用户可操作 |
|----------|----------|------------|
| 用户消息 | 发起需求、追问、反馈修改意见 | 输入文字、@ 引用节点 |
| 问题卡片 | AI 需要澄清关键决策时出现 | 选择选项、翻页、跳过、继续 |
| 执行计划 | 展示任务列表 + 悬浮进度条 | 开始执行、展开/收起进度 |
| 思考消息 | AI 处理复杂任务时展示推理过程 | 完成后可展开/折叠查看内容 |
| 操作反馈 | AI 执行操作后反馈（读取、创建节点等） | 点击定位按钮跳转画布（如适用） |

---

## 3. 消息类型定义

Chat 系统支持 5 种消息类型，每种类型有独立的展示规则和交互逻辑。

### 3.1 用户消息 / AI 消息

**场景**：用户发起需求、AI 回复分析结果

**用途**：基础对话，用户输入和 AI 文本回复

| 属性 | 用户消息 | AI 消息 |
|------|----------|---------|
| 对齐方式 | 右对齐 | 左对齐 |
| 背景样式 | 灰色气泡 | 无背景 |
| 宽度限制 | 最大 80% | 全宽 |
| 格式支持 | 纯文本 | Markdown 全格式 |

**AI 消息 Markdown 支持**：
- 标题（H1-H6）
- 无序/有序/任务列表
- 引用块、代码块
- 粗体、斜体、行内代码、链接

---

### 3.2 问题卡片消息

**场景**：AI 需要收集用户的产品决策（如项目类型、技术复杂度）

**用途**：通过选择题收集关键决策，确保产出符合用户预期

**卡片结构**：

卡片分为三个区域：
- **头部**：左侧显示问题图标和「Questions」标题，右侧显示分页信息（如 1/4）和上下翻页按钮
- **内容区**：显示当前问题文本，下方列出 A/B/C/D 选项；已回答的问题在标题旁显示勾选标记，选中的选项高亮显示
- **底部**：固定显示「跳过」和「继续」两个操作按钮

**交互规则**：

用户选择一个选项后，系统等待 300ms 显示选中效果，然后自动滚动到下一题。如果是最后一题，则停留在当前位置，等待用户操作。

| 操作 | 作用 |
|------|------|
| 选择选项 | 记录答案，自动滚动到下一题 |
| ▲▼ 翻页 | 浏览已答/未答问题 |
| 跳过 | 跳过当前问题，进入下一题 |
| 继续 | 结束问答，触发后续流程 |

**折叠状态**：
- 问答完成后自动折叠为摘要
- 摘要内容由 AI 根据用户回答生成，例如：「Question 1/4: 电商应用」

---

### 3.3 执行计划消息

**场景**：AI 分析完需求后，展示工作计划供用户确认

**用途**：让用户了解即将执行的任务，并主动触发执行

**卡片结构**：

卡片分为三个区域：
- **头部**：显示「EXECUTION PLAN」标题
- **任务列表**：纵向排列所有任务，每个任务前显示状态图标
- **底部**：首次显示时包含「开始执行」按钮，点击后按钮消失

**任务状态**：

| 状态 | 图标 | 说明 |
|------|------|------|
| pending | ○ | 等待执行 |
| loading | ⏳ | 正在执行（带旋转动画） |
| done | ✓ | 已完成（绿色） |

**启动与执行**：

用户点击「开始执行」按钮后：
1. 按钮立即消失（防止重复触发）
2. 输入框上方出现悬浮进度条
3. 当前任务状态变为 loading
4. AI 执行任务，发送操作反馈消息
5. 任务完成后状态变为 done，自动进入下一个任务
6. 重复直到所有任务完成

**悬浮进度条**：

执行计划启动后，输入框上方出现悬浮进度条，用于追踪整体进度。

收起状态（单行布局）：
- 当前任务的状态图标
- 当前任务名称
- 状态文字（Processing... 或 Execution complete）
- 进度比例（如 2/6）
- 展开/收起按钮

展开状态：
- 点击后在下方显示完整任务列表
- 已完成任务显示勾选图标，文字带删除线
- 执行中任务高亮显示
- 待执行任务显示空心圆图标

完成动画：
- 单个任务完成时：短暂高亮 + 缩放效果
- 全部完成时：显示「Execution complete」

---

### 3.4 思考消息

**场景**：AI 开始处理任务时，展示推理过程

**用途**：增强透明度和可解释性，让用户知道 AI 在"思考"

**两种状态**：

| 状态 | 展示形式 | 说明 |
|------|----------|------|
| 思考中 | 🧠 Thinking... | 跳动动画，表示正在处理 |
| 完成 | 🧠 Thought process ▶ | 可展开查看思考内容 |

**交互规则**：
- 思考完成后，内容默认折叠
- 点击可展开/收起查看详细推理过程

---

### 3.5 操作反馈消息

**场景**：AI 执行各类操作时，向用户反馈执行状态

**用途**：展示 AI 正在执行的具体操作，增强透明度和信任感

操作反馈消息按重要程度分为两种展示形式：

---

#### 3.5.1 轻量操作（简化文本）

适用于高频、不影响结果的辅助操作，以简化文本形式展示，不打断用户阅读。

| 操作类型 | 展示文案 | 对应命令 | 示例 |
|----------|----------|----------|------|
| 搜索代码 | Search | grep | Search user-stories |
| 读取文件 | Read | read, cat, head, tail | Read product-template.md |
| 浏览目录 | Browsing files | ls, list_dir | Browsing files in /src |

---

#### 3.5.2 重要操作（完整卡片）

适用于会产生实际结果的操作，以卡片形式展示，包含状态指示和交互按钮。

**卡片结构**（单行紧凑布局）：
- **左侧**：操作类型图标
- **中间**：操作名称 + 状态文字（Creating.../Created/Failed）
- **右侧**：操作成功后显示定位按钮（如适用）

**操作类型**：

| 操作类型 | 图标 | 说明 | 定位按钮 |
|----------|------|------|----------|
| 创建文档节点 | 📄 | 在画布创建 Document | ✓ |
| 创建白板节点 | 🎨 | 在画布创建 Whiteboard | ✓ |
| 创建原型节点 | 📱 | 在画布创建 Screen | ✓ |
| 创建数据表节点 | 📊 | 在画布创建 Table | ✓ |
| 创建集成节点 | 🔌 | 在画布创建 Integration | ✓ |
| 移动节点 | 📦 | 移动或重命名画布节点 | ✓ |
| 创建分区 | 📁 | 在画布创建 Section | ✓ |
| 删除节点 | 🗑️ | 删除画布节点 | - |
| 编辑文件 | 📝 | 编辑代码/配置文件 | - |
| 创建文件 | 📝 | 创建代码/配置文件 | - |

**状态指示**：
- 执行中：旋转加载图标
- 成功：绿色勾选图标
- 失败：红色错误图标

**交互规则**：
- 画布节点创建成功后显示「定位」按钮
- 点击定位按钮，画布自动平移并聚焦到该节点

---

## 4. @ Mention 功能

用户可在输入框中通过 @ 引用画布上的节点或内部元素，实现精准的上下文关联。

### 4.1 触发方式

| 方式 | 操作 | 说明 |
|------|------|------|
| 文本触发 | 输入 `@` | 必须在开头或空格后 |
| 画布选择 | 点击「从画布选择」 | 进入选择模式 |

### 4.2 Mention 面板

输入 `@` 后弹出选择面板，内容排序：
1. 「从画布选择」选项（置顶，有区分度的背景）
2. Section（分区）
3. 各类节点（按类型分组）

键盘操作：
- ↑/↓：上下选择
- Enter：确认选择
- Esc：关闭面板
- 继续输入：实时过滤

### 4.3 画布选择模式

点击「从画布选择」后进入选择模式，可选中画布上的节点或节点内部元素（如 Screen 中的 div）。

视觉反馈：
- 光标变为 pointer
- 悬停元素显示蓝色高亮框

退出方式：
- 点击目标元素（完成选择）
- 按 Esc 键（取消）
- 点击空白区域（取消）

### 4.4 引用效果

**输入框**：插入 `@节点名称` 或 `@节点名称-元素标识`

**画布**：
- 被引用节点/元素显示蓝色边框
- 左上方显示蓝色标签 `@名称 ×`
- 点击 × 可删除引用

**消息历史**：
- 按节点类型显示蓝色高亮

